# Архитектура проекта

## 1. Общая концепция и логика работы системы

### 1.1. Концепция

Система представляет собой промышленную ИИ-платформу для автоматизации и оптимизации производства на фабрике здорового питания. Архитектура спроектирована для обработки потоков данных в реальном времени от видеокамер, производственного оборудования и систем учета, обеспечивая компьютерное зрение, прогнозирование и аналитику.

### 1.2. Логика работы

1. **Сбор данных с производства:**
   - Видеопотоки с камер в производственных зонах (цех упаковки, маркировка, расфасовка)
   - Данные от производственного оборудования (время операций, загрузка линий)
   - Данные от систем учета (количество продукции, маркировка)

2. **Обработка в реальном времени:**
   - Компьютерное зрение анализирует видеопотоки (контроль персонала, качества, санитарии)
   - Система мониторинга собирает метрики оборудования и производства
   - События и инциденты фиксируются и обрабатываются

3. **Хранение и агрегация:**
   - Временные ряды метрик сохраняются в специализированное хранилище
   - Результаты анализа CV сохраняются в БД
   - Исторические данные используются для обучения моделей

4. **Прогнозирование и планирование:**
   - ML-модели прогнозируют спрос и планируют производство
   - Система планирования генерирует планы выпуска по сменам
   - Оптимизация загрузки оборудования и персонала

5. **Визуализация и аналитика:**
   - Дашборды для мониторинга в реальном времени
   - Отчеты и аналитика для менеджмента
   - Алерты и уведомления о критических событиях

---

## 2. Архитектурный стиль

### 2.1. Выбранный стиль: **Гибридная архитектура (Edge + Cloud + Microservices)**

### 2.2. Обоснование выбора

Архитектура состоит из трех уровней:

**1. Edge Layer (Периферийные устройства)**
- Обработка видеопотоков на месте (edge computing)
- Предварительная фильтрация и детекция событий
- Снижение нагрузки на сеть и центральные сервисы

**2. Cloud Layer (Облачные сервисы)**
- Микросервисная архитектура для основных компонентов
- Централизованная обработка данных
- ML-модели для прогнозирования

**3. Integration Layer (Слой интеграций)**
- Интеграция с производственным оборудованием
- Интеграция с системами учета (ERP, MES)
- API для внешних систем

**Преимущества:**
- **Низкая задержка** — обработка CV на edge устройствах
- **Масштабируемость** — независимое масштабирование компонентов
- **Надежность** — работа edge устройств при сбоях в облаке
- **Гибкость** — возможность использования разных технологий для разных задач

### 2.3. Архитектурный паттерн: Event-Driven Architecture

Система использует событийно-ориентированную архитектуру для:
- Обработки событий от камер и оборудования в реальном времени
- Асинхронной обработки данных
- Слабой связанности компонентов

---

## 3. Стек технологий

### 3.1. Computer Vision (Компьютерное зрение)

**Edge Computing:**
- **Платформа:** NVIDIA Jetson / Intel NUC / Промышленные ПК
- **Фреймворки ML:**
  - **PyTorch / TensorFlow** — для обучения моделей
  - **ONNX Runtime** — для инференса на edge устройствах
  - **OpenCV** — для обработки изображений
  - **YOLO / Detectron2** — для детекции объектов
- **Стриминг:** RTSP / WebRTC для видеопотоков

**Cloud Processing:**
- **Python 3.11+** с FastAPI для API
- **TensorFlow Serving / TorchServe** — для сервинга моделей
- **Apache Kafka** — для потоковой обработки видеоданных

### 3.2. Backend Services

**Основной стек:**
- **Язык:** Python 3.11+ (основной) для ML и аналитики
- **Фреймворки:**
  - **FastAPI** — для REST API и real-time endpoints
  - **Celery** — для асинхронных задач
- **Очереди сообщений:**
  - **RabbitMQ / Apache Kafka** — для событий и потоков данных
  - **Redis Streams** — для легковесных очередей

**ML/AI компоненты:**
- **scikit-learn** — для классических ML моделей
- **Prophet / ARIMA** — для прогнозирования временных рядов
- **Optuna** — для оптимизации гиперпараметров
- **MLflow** — для управления ML lifecycle

### 3.3. Frontend

**Основной стек:**
- **Фреймворк:** React 18+ с TypeScript
- **State Management:** Redux Toolkit
- **UI библиотека:** Material-UI / Ant Design
- **Real-time:** WebSocket для live дашбордов
- **Визуализация:** Plotly / D3.js / Apache ECharts

**Рекомендация:** React + TypeScript для дашбордов и аналитики

### 3.4. База данных

**Основная БД (OLTP):**
- **PostgreSQL 15+** — для реляционных данных (пользователи, конфигурации, результаты анализа)

**Временные ряды (Time Series):**
- **InfluxDB / TimescaleDB** — для метрик производства, оборудования, времени операций
- **Оптимизация:** Специализированные хранилища для временных рядов

**Кэш и очереди:**
- **Redis 7+** — для кэширования, сессий, real-time данных

**Хранилище видео и изображений:**
- **MinIO / AWS S3** — для хранения видеозаписей и снимков инцидентов

### 3.5. Инфраструктура

**Edge Infrastructure:**
- **Промышленные ПК / NVIDIA Jetson** — для обработки CV на месте
- **Docker** — для контейнеризации edge приложений
- **MQTT / OPC-UA** — для связи с производственным оборудованием

**Cloud Infrastructure:**
- **Контейнеризация:** Docker
- **Оркестрация:** Kubernetes для production
- **Облачная платформа:** AWS / Google Cloud / Azure
  - Рекомендация: **Google Cloud** (хорошая поддержка ML) или **AWS** (широкий спектр сервисов)

**Сетевая инфраструктура:**
- **VPN / Secure Tunnel** — для связи edge устройств с облаком
- **Load Balancer** — для распределения нагрузки
- **CDN** — для раздачи статики (если требуется)

### 3.6. Интеграции с производством

**Протоколы:**
- **OPC-UA / Modbus** — для связи с производственным оборудованием
- **MQTT** — для IoT устройств и датчиков
- **REST API** — для интеграции с ERP/MES системами
- **SQL / ODBC** — для прямого доступа к базам данных учета

**Типы интеграций:**
- Получение данных о планах производства
- Получение данных о фактическом выпуске
- Передача данных о времени операций
- Передача данных о простоях оборудования

### 3.7. Авторизация и безопасность

**Аутентификация:**
- **JWT (JSON Web Tokens)** — для stateless аутентификации
- **RBAC (Role-Based Access Control)** — для управления правами доступа
- **Интеграция с корпоративными системами** — если требуется

**Безопасность:**
- **HTTPS/TLS** — обязательное шифрование трафика
- **VPN / Secure Tunnel** — для связи edge устройств
- **Шифрование данных** — для чувствительных данных производства
- **Аудит доступа** — логирование всех действий пользователей
- **Защита от несанкционированного доступа** — к производственным данным

### 3.8. Мониторинг и логирование

**Мониторинг:**
- **Prometheus + Grafana** — для метрик и визуализации
- **Custom dashboards** — для производственных метрик
- **Alerting** — для критических событий

**Логирование:**
- **ELK Stack (Elasticsearch, Logstash, Kibana)** — для централизованного логирования
- **Structured logging** — JSON формат для анализа
- **Retention policies** — политики хранения логов

**Отслеживание ошибок:**
- **Sentry** — для отслеживания ошибок в приложениях
- **Custom error tracking** — для ошибок CV и ML моделей

### 3.9. CI/CD

**Инструменты:**
- **GitHub Actions / GitLab CI / Jenkins** — для автоматизации сборки и деплоя
- **Terraform** — для Infrastructure as Code
- **Helm** — для управления Kubernetes конфигурациями
- **Docker Registry** — для хранения образов

---

## 4. Модули системы и их взаимодействие

### 4.1. Основные модули

#### 4.1.1. Edge Computer Vision Service (CV Edge)
**Расположение:** На производстве (edge устройства)
- Прием видеопотоков с камер
- Real-time обработка видео (детекция объектов, классификация)
- Детекция событий (нарушения, инциденты)
- Предварительная фильтрация и агрегация данных
- Отправка событий и метрик в облако

**Технологии:** PyTorch/TensorFlow, ONNX Runtime, OpenCV, RTSP

#### 4.1.2. Computer Vision Service (CV Cloud)
**Расположение:** Облако
- Дополнительная обработка видео (если требуется)
- Обучение и обновление ML моделей
- Хранение результатов анализа
- Управление моделями (версионирование, A/B тестирование)

**Функции:**
- Контроль персонала (время операций, спецодежда, маски)
- Контроль качества (внешний вид, недовес/перевес)
- Контроль санитарии (уборка, розливы, рассыпания)

#### 4.1.3. Production Monitoring Service
**Расположение:** Облако
- Сбор метрик с производственного оборудования
- Мониторинг времени операций
- Отслеживание простоев оборудования
- Мониторинг загрузки линий
- Сбор данных о количестве упакованной и маркированной продукции

**Интеграции:** OPC-UA, Modbus, MQTT, REST API

#### 4.1.4. Forecasting & Planning Service
**Расположение:** Облако
- Прогнозирование спроса
- Планирование выпуска по сменам
- Планирование загрузки оборудования
- Планирование смен персонала
- Оптимизация производства (минимизация простоев, списаний)

**ML модели:** Prophet, ARIMA, LSTM, XGBoost

#### 4.1.5. Analytics & Reporting Service
**Расположение:** Облако
- Агрегация метрик производства
- Генерация отчетов
- Дашборды в реальном времени
- Историческая аналитика
- Сравнительный анализ (план vs факт)

**Метрики:**
- Загрузка линий
- Загрузка персонала
- Количество упакованной продукции
- Количество маркированной продукции
- Время простоя оборудования
- Объем списаний (особенно обечаек)

#### 4.1.6. Integration Service
**Расположение:** Облако
- Интеграция с ERP/MES системами
- Получение планов производства
- Передача данных о фактическом выпуске
- Синхронизация данных
- API для внешних систем

#### 4.1.7. Notification & Alerting Service
**Расположение:** Облако
- Уведомления о критических событиях
- Алерты о нарушениях
- Отчеты по расписанию
- Интеграция с корпоративными системами уведомлений

#### 4.1.8. User Management Service
**Расположение:** Облако
- Управление пользователями
- Аутентификация и авторизация
- Роли и права доступа
- Аудит действий пользователей

#### 4.1.9. Dashboard Service (Frontend)
**Расположение:** Облако
- Web-интерфейс для пользователей
- Real-time дашборды
- Отчеты и аналитика
- Настройка конфигураций
- Управление моделями CV

### 4.2. Взаимодействие модулей

```
┌─────────────────────────────────────────────────────────┐
│              Production Floor (Edge Layer)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Cameras    │  │  Equipment   │  │   Sensors    │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                 │                 │           │
│         ▼                 ▼                 ▼           │
│  ┌─────────────────────────────────────────────────┐  │
│  │      CV Edge Service (NVIDIA Jetson / PC)        │  │
│  │  - Real-time video processing                    │  │
│  │  - Event detection                               │  │
│  └──────────────────────┬──────────────────────────┘  │
└─────────────────────────┼─────────────────────────────┘
                           │
                           │ (MQTT / Kafka / VPN)
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Cloud Layer                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Message Queue (Kafka)                 │  │
│  └──────┬───────────────────────┬───────────────────┘  │
│         │                       │                        │
│         ▼                       ▼                        │
│  ┌──────────────┐      ┌──────────────┐                 │
│  │ CV Service   │      │  Monitoring  │                 │
│  │  (Cloud)     │      │   Service    │                 │
│  └──────┬───────┘      └──────┬───────┘                 │
│         │                     │                          │
│         └──────────┬──────────┘                          │
│                    ▼                                     │
│         ┌─────────────────────┐                           │
│         │  Time Series DB    │                           │
│         │  (InfluxDB)        │                           │
│         └─────────┬─────────┘                           │
│                   │                                      │
│         ┌─────────┴─────────┐                           │
│         │                   │                           │
│         ▼                   ▼                           │
│  ┌──────────────┐  ┌──────────────┐                     │
│  │ Forecasting  │  │  Analytics    │                     │
│  │   Service    │  │   Service    │                     │
│  └──────┬───────┘  └──────┬───────┘                     │
│         │                 │                              │
│         └─────────┬───────┘                              │
│                   ▼                                      │
│         ┌─────────────────────┐                          │
│         │  PostgreSQL DB     │                          │
│         └─────────┬─────────┘                           │
│                   │                                      │
│         ┌─────────┴─────────┐                           │
│         │                   │                           │
│         ▼                   ▼                           │
│  ┌──────────────┐  ┌──────────────┐                     │
│  │ Integration  │  │  Dashboard   │                     │
│  │   Service    │  │   Service    │                     │
│  └──────────────┘  └──────┬───────┘                     │
│                           │                              │
│                           ▼                              │
│                  ┌──────────────┐                        │
│                  │   Users      │                        │
│                  │  (Browser)   │                        │
│                  └──────────────┘                        │
└──────────────────────────────────────────────────────────┘
```

**Принципы взаимодействия:**
- **Real-time обработка** — события обрабатываются немедленно
- **Асинхронное взаимодействие** — через очереди сообщений (Kafka)
- **Event-Driven** — события для слабосвязанного взаимодействия
- **Batch processing** — для обучения моделей и генерации отчетов

---

## 5. Хранилища данных и ключевые сущности

### 5.1. Основная база данных (PostgreSQL)

**Основные таблицы/сущности:**

#### Users (Пользователи)
- id, email, password_hash, role, department, created_at, updated_at, status

#### Production_Zones (Производственные зоны)
- id, name, description, zone_type (packaging, marking, etc.), camera_ids

#### Cameras (Камеры)
- id, zone_id, name, rtsp_url, status, location, configuration

#### Production_Plans (Планы производства)
- id, date, shift, product_id, planned_quantity, start_time, end_time

#### Production_Actual (Фактический выпуск)
- id, plan_id, product_id, quantity_packaged, quantity_marked, timestamp

#### CV_Events (События компьютерного зрения)
- id, camera_id, event_type (personnel_violation, quality_issue, sanitation), 
  timestamp, details (JSON), image_path, severity

#### Equipment (Оборудование)
- id, name, zone_id, equipment_type, status, specifications

#### Equipment_Downtime (Простои оборудования)
- id, equipment_id, start_time, end_time, duration, reason, zone_id

#### Personnel_Operations (Операции персонала)
- id, employee_id, operation_type, start_time, end_time, duration, zone_id

#### Quality_Checks (Проверки качества)
- id, product_id, check_type (weight, appearance), result, timestamp, cv_event_id

### 5.2. Временные ряды (InfluxDB / TimescaleDB)

**Метрики (Time Series):**

#### Production_Metrics
- timestamp, zone_id, product_id
- quantity_packaged, quantity_marked
- line_utilization, personnel_utilization
- downtime_duration, operation_duration

#### Equipment_Metrics
- timestamp, equipment_id
- status, utilization, throughput
- error_count, maintenance_events

#### CV_Metrics
- timestamp, camera_id, zone_id
- events_detected, violations_count
- processing_latency, model_confidence

### 5.3. Кэш (Redis)

**Использование:**
- Сессии пользователей
- Real-time метрики для дашбордов
- Кэширование результатов ML моделей
- Rate limiting для API
- Временные токены

### 5.4. Файловое хранилище (Object Storage)

**Хранение:**
- Видеозаписи инцидентов
- Снимки нарушений (CV events)
- Отчеты и экспорты
- Конфигурации моделей

**Технологии:** MinIO / AWS S3 / Google Cloud Storage

---

## 6. Типы интеграций с внешними системами

### 6.1. Платежные системы
- **REST API** — для инициации платежей
- **Webhooks** — для получения статусов платежей
- **SDK** — для упрощения интеграции

### 6.2. Email сервисы
- **SMTP** — для отправки email
- **API (SendGrid, Mailgun, AWS SES)** — для массовых рассылок

### 6.3. SMS сервисы
- **REST API (Twilio, AWS SNS)** — для отправки SMS

### 6.4. Социальные сети
- **OAuth 2.0** — для авторизации через соцсети
- **Graph API** — для получения данных пользователей

### 6.5. Аналитика
- **Google Analytics / Mixpanel** — для веб-аналитики
- **API** — для отправки событий

---

## 7. Требования к инфраструктуре, CI/CD и безопасности

### 7.1. Инфраструктура

**Минимальные требования:**
- **Production:** 3+ серверов (для отказоустойчивости)
- **Staging:** 1-2 сервера
- **Development:** локальные окружения

**Рекомендуемая конфигурация:**
- **Load Balancer** — для распределения нагрузки
- **Auto Scaling** — для автоматического масштабирования
- **Backup** — ежедневные бэкапы БД
- **Disaster Recovery** — план восстановления после сбоев

### 7.2. CI/CD

**Pipeline этапы:**
1. **Lint & Test** — проверка кода и запуск тестов
2. **Build** — сборка Docker образов
3. **Security Scan** — сканирование на уязвимости
4. **Deploy to Staging** — деплой на тестовое окружение
5. **Integration Tests** — интеграционные тесты
6. **Deploy to Production** — деплой на production (после approval)

**Инструменты:**
- **GitHub Actions / GitLab CI**
- **Docker Registry**
- **Kubernetes** для оркестрации

### 7.3. Безопасность

**Меры безопасности:**
- **HTTPS/TLS** — обязательное шифрование
- **Secrets Management** — Vault / AWS Secrets Manager
- **Network Security** — VPC, Security Groups, Firewalls
- **DDoS Protection** — Cloudflare / AWS Shield
- **Regular Security Audits** — регулярные проверки безопасности
- **Compliance** — соответствие GDPR, PCI DSS (если требуется)

---

## 8. Возможности масштабирования и отказоустойчивости

### 8.1. Масштабирование

**Горизонтальное масштабирование:**
- Добавление новых инстансов сервисов
- Load balancing для распределения нагрузки
- Database replication для чтения

**Вертикальное масштабирование:**
- Увеличение ресурсов серверов (CPU, RAM)

**Автомасштабирование:**
- На основе метрик (CPU, Memory, Request Rate)
- Kubernetes HPA (Horizontal Pod Autoscaler)

### 8.2. Отказоустойчивость

**Стратегии:**
- **Redundancy** — дублирование критичных компонентов
- **Health Checks** — мониторинг здоровья сервисов
- **Circuit Breaker** — защита от каскадных отказов
- **Retry Logic** — повторные попытки при временных сбоях
- **Graceful Degradation** — деградация функциональности при сбоях
- **Database Failover** — автоматическое переключение на резервную БД

**RTO (Recovery Time Objective):** < 1 час  
**RPO (Recovery Point Objective):** < 15 минут

---

## 9. Диаграммы архитектуры

### 9.1. Общая архитектура (текстовое описание)

```
┌─────────────────────────────────────────────────────────┐
│                      Client Layer                        │
│              (Web, Mobile, Third-party APIs)             │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                    API Gateway                          │
│         (Routing, Rate Limiting, Authentication)        │
└───────────────────────┬─────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Auth Service │ │ Core Service │ │ File Service │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                 │
       ▼                ▼                 ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   User DB    │ │   Core DB    │ │ Object Store │
└──────────────┘ └──────────────┘ └──────────────┘
                        │
                        ▼
              ┌─────────────────┐
              │  Message Queue  │
              │   (RabbitMQ)    │
              └────────┬────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│Notification  │ │  Analytics   │ │  Payment     │
│   Service    │ │   Service    │ │   Service    │
└──────────────┘ └──────────────┘ └──────────────┘
```

### 9.2. Поток данных (текстовое описание)

**Типичный запрос:**
1. Клиент отправляет запрос → API Gateway
2. API Gateway проверяет аутентификацию → Auth Service
3. API Gateway маршрутизирует запрос → соответствующий сервис
4. Сервис обрабатывает запрос → обращается к БД
5. Сервис отправляет событие → Message Queue (если требуется)
6. Ответ возвращается клиенту через API Gateway

**Асинхронная обработка:**
1. Сервис публикует событие → Message Queue
2. Worker подхватывает событие → обрабатывает
3. Worker может вызвать другие сервисы или внешние API
4. Результат сохраняется в БД или отправляется уведомление

---

## 10. Заключение

Данная архитектура обеспечивает:
- ✅ Масштабируемость и производительность
- ✅ Надежность и отказоустойчивость
- ✅ Безопасность и соответствие стандартам
- ✅ Гибкость для будущего развития
- ✅ Поддерживаемость и тестируемость

Архитектура может быть адаптирована под конкретные требования проекта после получения детального брифа от заказчика.

---

**Документ подготовлен:** 2025-01-27  
**Последнее обновление:** 2025-01-27

